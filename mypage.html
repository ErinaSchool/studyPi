<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- -----------firebase CDN------------- -->
    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-database.js"></script>
    <script src="firebase.js"></script>

    <!-- chart.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.9.3/Chart.min.js"
        integrity="sha512-s+xg36jbIujB2S2VKfpGmlC3T5V2TF3lY48DX7u2r9XzGzgPsa6wTpOQA7J9iffvdeBN0q9tKzRxVxw1JviZPg=="
        crossorigin="anonymous"></script>

    <!-- moment.js -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/moment.js/2.27.0/moment.min.js"
        integrity="sha512-rmZcZsyhe0/MAjquhTgiUcb4d9knaFc7b5xAfju483gbEXTkeJRUMIPk6s3ySZMYUHEcjKbjLjyddGWMrNEvZg=="
        crossorigin="anonymous"></script>
</head>

<body onload="init();">
    <div id="logout-button">
        <a>ログアウト</a>
    </div>
    <div>
        <a href="index.html">ホーム</a>
    </div>
    <div id="getData"></div>
    <form name="newRecord">
        <input name="date" type="date">
        <input name="time" type="time">
        <input name="term" type="number">
        <input type="button" onclick="createRecord()" value='新規作成'>
    </form>

    <div style="top:60px; left:10px; width:800px; height:800px;">
        <canvas id="myChart"></canvas>
    </div>
    <script>
        // ログアウトの処理
        document.getElementById("logout-button").onclick = function () {
            firebase.auth().signOut().then(function () {
                location.href = './login.html';
            }).catch(function (error) {
                console.log(error)
            });
        };

        // firebaseからuserの記録を持ってくる関数
        // ここにページが読み込まれたら読み込む処理を書く
        function readRecordData() {
            firebase.auth().onAuthStateChanged(function (user) {
                firebase.database().ref('/records/' + user.uid).once('value').then(function (snapshot) {
                    var data = snapshot.val()
                    console.log(data);
                    var json = JSON.stringify(data);
                    console.log(json[1]);
                    document.getElementById("getData").textContent = json;
                    // データを表示する
                });
            });
        }

        function init() {
            is_login()
            drawRecordChart()
        }

        // ログインしているか判定し、していなければログインページへ飛ばす関数
        function is_login() {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    console.log('userId: ' + user.uid)
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        // 勉強時間新規登録の処理
        function createRecord() {
            const date = document.forms.newRecord.date.value
            const time = document.forms.newRecord.time.value
            const term = document.forms.newRecord.term.value
            if (!date || !time || !term) {
                alert("未入力の項目があります")
            } else {
                const userId = firebase.auth().currentUser.uid
                firebase.database().ref('records/' + userId).push().set({
                    date: date,
                    time: time,
                    term: term
                });
                drawRecordChart()
                document.forms.newRecord.reset()
            }
        }



        function drawRecordChart() {
            firebase.auth().onAuthStateChanged(function (user) {
                firebase.database().ref('/records/' + user.uid).once('value').then(function (snapshot) {
                    var data = snapshot.val()
                    var now = moment().format('YYYY-MM-DD')
                    var barLabels = [
                        moment(now, 'YYYY-MM-DD').subtract(6, 'days').format('DD') + '日',
                        moment(now, 'YYYY-MM-DD').subtract(5, 'days').format('DD') + '日',
                        moment(now, 'YYYY-MM-DD').subtract(4, 'days').format('DD') + '日',
                        moment(now, 'YYYY-MM-DD').subtract(3, 'days').format('DD') + '日',
                        moment(now, 'YYYY-MM-DD').subtract(2, 'days').format('DD') + '日',
                        moment(now, 'YYYY-MM-DD').subtract(1, 'days').format('DD') + '日',
                        moment(now, 'YYYY-MM-DD').format('DD') + '日'
                    ]
                    // 配列の番号はx日前を示している。例　barData[2] 2日前の勉強時間
                    var barData = [
                        0, 0, 0, 0, 0, 0, 0
                    ]
                    for (let key in data) {
                        var diff = moment(now, 'YYYY-MM-DD').diff(moment(data[key]['date'], 'YYYY-MM-DD'), 'days');
                        if (diff == 0) {
                            barData[0] += Number(data[key]['term'])
                        } else if (diff == 1) {
                            barData[1] += Number(data[key]['term'])
                        } else if (diff == 2) {
                            barData[2] += Number(data[key]['term'])
                        } else if (diff == 3) {
                            barData[3] += Number(data[key]['term'])
                        } else if (diff == 4) {
                            barData[4] += Number(data[key]['term'])
                        } else if (diff == 5) {
                            barData[5] += Number(data[key]['term'])
                        } else if (diff == 6) {
                            barData[6] += Number(data[key]['term'])
                        }
                    }
                    console.log(barData)

                    var ctx = document.getElementById("myChart");
                    var myChart = new Chart(ctx, {
                        type: 'bar',
                        data: {
                            labels: barLabels,
                            datasets: [{
                                label: '勉強時間',
                                // barDataには日付の遅い順にデータが入っている。しかし、日付の早い順に表示したいため、reberse()を使う
                                data: barData.reverse(),
                                backgroundColor: [
                                    'rgba(255, 99, 132, 0.2)',
                                    'rgba(54, 162, 235, 0.2)',
                                    'rgba(255, 206, 86, 0.2)',
                                    'rgba(75, 192, 192, 0.2)',
                                    'rgba(153, 102, 255, 0.2)',
                                    'rgba(255, 159, 64, 0.2)'
                                ],
                                borderColor: [
                                    'rgba(255,99,132,1)',
                                    'rgba(54, 162, 235, 1)',
                                    'rgba(255, 206, 86, 1)',
                                    'rgba(75, 192, 192, 1)',
                                    'rgba(153, 102, 255, 1)',
                                    'rgba(255, 159, 64, 1)'
                                ],
                                borderWidth: 1
                            }]
                        },
                        options: {
                            responsive: true,
                            scales: {
                                yAxes: [{
                                    ticks: {
                                        beginAtZero: true
                                    },
                                    categoryPercentage: 0.9,
                                    barPercentage: 0.5,
                                }]
                            },
                            layout: {                             //レイアウト
                                padding: {                          //余白設定
                                    left: 100,
                                    right: 50,
                                    top: 0,
                                    bottom: 0
                                }
                            }
                        }
                    });

                });
            });
        }
    </script>
</body>

</html>