<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <!-- -----------firebase CDN------------- -->
    <!-- Insert these scripts at the bottom of the HTML, but before you use any Firebase services -->
    <!-- Firebase App (the core Firebase SDK) is always required and must be listed first -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-app.js"></script>
    <!-- Add Firebase products that you want to use -->
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-auth.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-firestore.js"></script>
    <script src="https://www.gstatic.com/firebasejs/6.2.0/firebase-database.js"></script>
    <script src="firebase.js"></script>
</head>

<body onload="init();">
    <div id="logout-button">
        <a>ログアウト</a>
    </div>
    <div>
        <a href="index.html">ホーム</a>
    </div>
    <div id="getData"></div>

    <form name="newRecord">
        <input name="date" type="date">
        <input name="time" type="time">
        <input name="term" type="number">
        <input type="button" onclick="createRecord()" value='新規作成'>
    </form>

    <script>
        // ログアウトの処理
        document.getElementById("logout-button").onclick = function () {
            firebase.auth().signOut().then(function () {
                location.href = './login.html';
            }).catch(function (error) {
                console.log(error)
            });
        };

        // firebaseからuserの記録を持ってくる関数
        // ここにページが読み込まれたら読み込む処理を書く
        function readRecordData() {
            firebase.auth().onAuthStateChanged(function (user) {
                firebase.database().ref('/records/' + user.uid).once('value').then(function (snapshot) {
                    var data = snapshot.val()
                    console.log(data);
                    var json = JSON.stringify(data);
                    console.log(json[1]);
                    document.getElementById("getData").textContent = json;
                    // データを表示する
                });
            });
        }

        function init() {
            is_login()
            readRecordData()
        }

        // ログインしているか判定し、していなければログインページへ飛ばす関数
        function is_login() {
            firebase.auth().onAuthStateChanged(function (user) {
                if (user) {
                    console.log('userId: ' + user.uid)
                } else {
                    window.location.href = 'login.html';
                }
            });
        }

        // 勉強時間新規登録の処理
        function createRecord() {
            const date = document.forms.newRecord.date.value
            const time = document.forms.newRecord.time.value
            const term = document.forms.newRecord.term.value
            if (!date || !time || !term) {
                alert("未入力の項目があります")
            } else {
                const userId = firebase.auth().currentUser.uid
                firebase.database().ref('records/' + userId).push().set({
                    date: date,
                    time: time,
                    term: term
                });
            }
        }
    </script>
</body>

</html>